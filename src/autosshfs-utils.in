#!/bin/bash

## LICENSE
#
# Copyright 2011,2012,2013 hellekin <hellekin@riseup.net>
# Copyright 2018 A. Lochmann <info@alexander-lochmann.de>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>,
# or, from the package source directory, run: make license
#
PREFIX="%PREFIX%"

create_ssh_wrapper() {
local generator="# Generated by ${PROGNAME} at $(date -R)"
local outfile=${1}
local username=${2}

cat > ${outfile} <<EOD
#!/bin/sh
#
# autosshfs-as-${username}
#
# Wrapper script to make automount use the user's ssh-agent(1)
# when mounting SSHFS.  It is used as the ssh-command by autofs(8).
#

if [ \`id -un\` != "root" ]; then
  logger -s -i -t autosshfs "user \${USER} is not authorized to run autosshfs-as-${username}"
  exit 1
fi

# automount(8) sends -a -x -oClearAllForwardings=yes -2 HOST -s sftp
exec sudo -H -u ${username} -i ${PREFIX}/bin/autosshfs-ssh "\${5}"
${generator}
EOD

chmod 0755 ${outfile}
}

